<%- include('../partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-currency-dollar me-2"></i>Manage Pricing</h2>
    <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#pricingModal">
            <i class="bi bi-plus-circle me-2"></i>Add New Service
        </button>
        <a href="/admin/dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- SUCCESS MESSAGE -->
<% if (typeof success !== "undefined") { %>
<div class="alert alert-success">
    <i class="bi bi-check-circle me-2"></i><%= success %>
</div>
<% } %>

<!-- ERROR MESSAGE -->
<% if (typeof error !== "undefined") { %>
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle me-2"></i><%= error %>
</div>
<% } %>

<div class="row g-4">

    <!-- Pricing Table -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5><i class="bi bi-list me-2"></i>Service Pricing</h5>
            </div>
            <div class="card-body">

                <% if (!pricing || pricing.length === 0) { %>

                <div class="text-center py-5">
                    <i class="bi bi-currency-dollar text-muted" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mt-3">No pricing added yet</h4>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pricingModal">
                        <i class="bi bi-plus-circle me-2"></i>Add Service Pricing
                    </button>
                </div>

                <% } else { %>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Service Type</th>
                                <th>Price (per KG)</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th width="110">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% pricing.forEach(item => { %>
                            <tr>
                                <td><strong><%= item.service_type %></strong></td>
                                <td class="fw-bold text-success">$<%= item.price_per_kg %></td>
                                <td><%= item.description || "No description" %></td>
                                <td>
                                    <% if (item.status === "active") { %>
                                        <span class="badge bg-success">Active</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary">Inactive</span>
                                    <% } %>
                                </td>
                                <td>
                                    <!-- EDIT BUTTON -->
                                    <button class="btn btn-sm btn-outline-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#pricingModal"
                                        data-id="<%= item.id %>"
                                        data-type="<%= item.service_type %>"
                                        data-price="<%= item.price_per_kg %>"
                                        data-desc="<%= item.description %>"
                                        data-status="<%= item.status %>">
                                        <i class="bi bi-pencil"></i>
                                    </button>

                                    <!-- DELETE BUTTON -->
                                    <form action="/admin/pricing/delete/<%= item.id %>" method="POST" class="d-inline">
                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('Delete this service?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <% } %>

            </div>
        </div>
    </div>

    <!-- Tips Sidebar -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5><i class="bi bi-lightbulb me-2"></i>Pricing Tips</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li>Research competitor pricing</li>
                    <li>Premium pricing for express services</li>
                    <li>Update prices based on material cost</li>
                    <li>Offer bundle or bulk discounts</li>
                    <li>Track popular services to adjust prices</li>
                </ul>
            </div>
        </div>
    </div>

</div>

<!-- MODAL -->
<div class="modal fade" id="pricingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle">Add New Service</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" action="/admin/pricing/save">
                <div class="modal-body">

                    <input type="hidden" name="id" id="service_id">

                    <div class="mb-3">
                        <label class="form-label">Service Type</label>
                        <input type="text" id="service_type" name="service_type" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Price per KG</label>
                        <input type="number" id="price_per_kg" name="price_per_kg"
                               class="form-control" min="1" step="0.1" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="description" name="description" class="form-control"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select id="status" name="status" class="form-select">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary">Save</button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
// Fill modal data for EDIT mode
document.getElementById("pricingModal").addEventListener("show.bs.modal", e => {
    const btn = e.relatedTarget;

    if (btn && btn.getAttribute("data-id")) {
        // Editing existing service
        document.getElementById("modalTitle").innerText = "Edit Service";
        document.getElementById("service_id").value = btn.getAttribute("data-id");
        document.getElementById("service_type").value = btn.getAttribute("data-type");
        document.getElementById("price_per_kg").value = btn.getAttribute("data-price");
        document.getElementById("description").value = btn.getAttribute("data-desc") || "";
        document.getElementById("status").value = btn.getAttribute("data-status");
    } else {
        // Add new service
        document.getElementById("modalTitle").innerText = "Add New Service";
        document.getElementById("service_id").value = "";
        document.getElementById("service_type").value = "";
        document.getElementById("price_per_kg").value = "";
        document.getElementById("description").value = "";
        document.getElementById("status").value = "active";
    }
});
</script>

<%- include('../partials/footer') %>
